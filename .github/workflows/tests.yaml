name: Test
on:
- pull_request
- push
jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: nixbuild/nix-quick-install-action@v17
      with:
        nix_conf: experimental-features = nix-command flakes
    - run: nix-shell --pure --run "go test -v --race ./cmd/... ./internal/..."
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: nixbuild/nix-quick-install-action@v17
      with:
        nix_conf: experimental-features = nix-command flakes
    - run: nix-shell --pure --run "GOROOT=$(go env GOROOT) golangci-lint run -v --timeout 15m"
  e2e:
    needs:
    - unit
    - lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: nixbuild/nix-quick-install-action@v17
      with:
        nix_conf: experimental-features = nix-command flakes
    - run: nix-build nix/test.nix
